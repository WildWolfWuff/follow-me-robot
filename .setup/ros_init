used_shell=${SHELL##*/}
. ./func/func.$used_shell
distro=iron
source=../src

while getopts ":hd:s:p:" opt; do
    case $opt in
        d)
           distro="${OPTARG}"
           printInfo "use distro $distro"
        ;;
        s)
            source="${OPTARG}"
            printInfo "use source $source"
        ;;
        ?|h)
            printText "Usage: $(basename $0) [-d ros distro] [-s source folder] [-h]"
            exit 1
        ;;
    esac
done

printStep "Init ros scripts"
source /opt/ros/${distro}/setup.$used_shell
if [ $? -gt 0 ]; then
    exit 1;
fi
printStep "Init rosdep"
if [ -f /etc/ros/rosdep/sources.list.d/20-default.list ]; then
    sudo rm -rf /etc/ros/rosdep/sources.list.d/20-default.list
fi

sudo rosdep init
if [ $? -gt 0 ]; then
    exit 1;
fi

printStep "Update rosdep"
rosdep update
if [ $? -gt 0 ]; then
    exit 1;
fi

rosdep install --from-paths $source --ignore-src --rosdistro ${ROS_DISTRO} -r -y
if [ $? -gt 0 ]; then
    exit 1;
fi
./ros_install_packages -d ${ROS_DISTRO} \
    -p joint-state-publisher \
    -p joint-state-publisher-gui \
    -p xacro \
    -p gazebo-ros-pkgs
if [ $? -gt 0 ]; then
    exit 1;
fi
# https://github.com/christianrauch/apriltag_ros
./ros_install_packages -d ${ROS_DISTRO} \
    -p apriltag-ros \
    -p v4l2-camera \
if [ $? -gt 0 ]; then
    exit 1;
fi

printStep "Build project"
workspace=${PWD%/*}
curentDir=$PWD
cd $workspace
printInfo "use workspace $workspace"
if [ -d ./build ] || [ -d ./install ]; then
    printStep "Celanup existing builds"
    rm -rf ./build ./install
fi
colcon build
cd $curentDir
used_shell=${SHELL##*/}
. ./func/func.$used_shell
distro=$ROS_DISTRO
source=../src

while getopts ":hd:s:p:" opt; do
    case $opt in
        d)
           distro="${OPTARG}"
           printInfo "use distro $distro"
        ;;
        s)
            source="${OPTARG}"
            printInfo "use source $source"
        ;;
        ?|h)
            printText "Usage: $(basename $0) [-d ros distro] [-s source folder] [-h]"
            exit 1
        ;;
    esac
done

printStep "Init ros scripts"
printInfo "use /opt/ros/${distro}/setup.$used_shell"
source /opt/ros/${distro}/setup.$used_shell
if [ $? -gt 0 ]; then
    exit 1;
fi
printStep "Init rosdep"
if [ -f /etc/ros/rosdep/sources.list.d/20-default.list ]; then
    sudo rm -rf /etc/ros/rosdep/sources.list.d/20-default.list
fi
sudo rosdep init
if [ $? -gt 0 ]; then
    exit 1;
fi

sudo rosdep fix-permissions

printStep "Update rosdep"
rosdep update
if [ $? -gt 0 ]; then
    exit 1;
fi
printStep "Install rosdep"
rosdep install --from-paths $source --ignore-src --rosdistro ${distro} -r -y
if [ $? -gt 0 ]; then
    exit 1;
fi

printStep "Build project"
workspace=${PWD%/*}
curentDir=$PWD
cd $workspace
printInfo "use workspace $workspace"
if [ -d ./build ] || [ -d ./install ]; then
    printStep "Celanup existing builds"
    rm -rf ./build ./install
fi
colcon build
cd $curentDir